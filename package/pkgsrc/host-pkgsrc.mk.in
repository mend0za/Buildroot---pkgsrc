#
# NetBSD package collection (pkgsrc)
# Host (platform) build support
#


PKGSRC_SITE = ftp://ftp.NetBSD.org/pub/pkgsrc/pkgsrc-$(PKGSRC_VERSION)
PKGSRC_SOURCE = pkgsrc-$(PKGSRC_VERSION).tar.gz
PKGSRC_INSTALL_STAGING = yes


PKGSRC_HOST_WORK_DIR := $(BUILD_DIR)/host-pkgsrc-workdir

PKGSRC_DEPENDENCIES = $(BASE_TARGETS) host-flex host-bison host-ncurses host-fakeroot host-libtool
PKGSRC_PLATFORM_TOOLS = pkgtools/digest net/tnftp

PKGSRC_SH = /bin/bash

PKGSRC_BMAKE_HOST_OPTS := \
	USE_DESTDIR=no \
	USE_CROSS_COMPILE=no \
	CC=$(HOSTCC_NOCCACHE) 


# TODO use HOSTCC with CCACHE (now broken on devel/bmake build)
define HOST_PKGSRC_BUILD_CMDS
	( cd $(PKGSRC_SOURCE_DIR)/bootstrap ; \
		export SH="$(PKGSRC_SH)" PATH="$(HOST_DIR)/usr/bin:$(PATH)"; \
		export CC="$(HOSTCC_NOCCACHE)"; \
		fakeroot ./bootstrap \
			--workdir="$(PKGSRC_HOST_WORK_DIR)" \
			--prefix="$(PKGSRC_HOST_DIR)" \
	)
	# --pkgdbdir="$(PKGSRC_HOST_DIR)/var/db-pkg" 
	# --full 

endef

define PKGSRC_INSTALL_MK_CONF
	#$(INSTALL) -D -m 0644 $(TOPDIR)/package/pkgsrc/mk.conf.tmpl $(PKGSRC_HOST_DIR)/etc/mk.conf
endef

define PKGSRC_SET_CROSS_COMPILE_ROOT
	for pkg in $(PKGSRC_PLATFORM_TOOLS); \
		do \
		export PATH="$(HOST_DIR)/usr/bin:$(PKGSRC_HOST_DIR)/bin:$(PATH)"; \
		$(PKGSRC_BMAKE) -C $(PKGSRC_SOURCE_DIR)/$$pkg $(PKGSRC_BMAKE_HOST_OPTS) install; \
		done
endef

HOST_PKGSRC_POST_BUILD_HOOKS += PKGSRC_INSTALL_MK_CONF PKGSRC_SET_CROSS_COMPILE_ROOT

define HOST_PKGSRC_CLEAN_CMDS
	#rm -rf $(PKGSRC_SOURCE_DIR)/
	rm -rf $(PKGSRC_HOST_WORK_DIR)/
	rm -rf $(PKGSRC_HOST_DIR)/
endef

$(eval $(call GENTARGETS,host))
