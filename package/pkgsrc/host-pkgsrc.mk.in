#
# NetBSD package collection (pkgsrc)
# Host (platform) build support
#


PKGSRC_SITE = ftp://ftp.NetBSD.org/pub/pkgsrc/pkgsrc-$(PKGSRC_VERSION)
PKGSRC_SOURCE = pkgsrc-$(PKGSRC_VERSION).tar.gz
PKGSRC_INSTALL_STAGING = yes

PKGSRC_HOST_WORK_DIR := $(BUILD_DIR)/pkgsrc-workdir/host
PKGSRC_HOST_PKG_DIR := $(PKGSRC_HOST_WORK_DIR)/packages  

HOST_PKGSRC_DEPENDENCIES = $(BASE_TARGETS) host-flex host-bison host-ncurses host-fakeroot

PKGSRC_PLATFORM_TOOLS=pkgtools/digest net/tnftp pkgtools/pkg_summary-utils parallel/paexec lang/perl5 devel/libtool
#devel/mk-configure parallel/paexec 
#pkgtools/digest net/tnftp archivers/pax

PKGSRC_SH = /bin/bash

PKGSRC_BMAKE_HOST_OPTS := \
	CC="$(HOSTCC_NOCCACHE)" \
	WRKOBJDIR="$(PKGSRC_HOST_WORK_DIR)" \
	PACKAGES="$(PKGSRC_HOST_PKG_DIR)" \
	TOOLDIR=$(PKGSRC_HOST_DIR)/bin 


# TODO use HOSTCC with CCACHE (now broken on devel/bmake build)
define HOST_PKGSRC_BUILD_CMDS
	( cd $(PKGSRC_SOURCE_DIR)/bootstrap ; \
		export SH="$(PKGSRC_SH)" PATH="$(HOST_DIR)/usr/bin:$(PATH)"; \
		export CC="$(HOSTCC_NOCCACHE)"; \
		export CFLAGS="$(HOSTCFLAGS)"; \
		fakeroot ./bootstrap \
			--workdir="$(PKGSRC_HOST_WORK_DIR)" \
			--prefix="$(PKGSRC_HOST_DIR)" \
	)
endef

define PKGSRC_INSTALL_MK_CONF
	#$(INSTALL) -D -m 0644 $(TOPDIR)/package/pkgsrc/mk.conf.tmpl $(PKGSRC_HOST_DIR)/etc/mk.conf
endef

define PKGSRC_SET_CROSS_COMPILE_ROOT
	( \
		export PATH="$(HOST_DIR)/usr/bin:$(PKGSRC_HOST_DIR)/bin:$(PATH)"; \
		for pkg in $(PKGSRC_PLATFORM_TOOLS); 
		do \
			$(PKGSRC_BMAKE) -C $(PKGSRC_SOURCE_DIR)/$$pkg $(PKGSRC_BMAKE_HOST_OPTS) install ; \
		done; \
	)
	$(INSTALL) -D -m 0644 $(HOST_DIR)/usr/$(REAL_GNU_TARGET_NAME)/sysroot/usr/include/linux/stddef.h \
		$(PKGSRC_DEST_DIR)/usr/include/stddef.h
endef

HOST_PKGSRC_POST_BUILD_HOOKS += PKGSRC_INSTALL_MK_CONF PKGSRC_SET_CROSS_COMPILE_ROOT

define HOST_PKGSRC_CLEAN_CMDS
	rm -rf $(PKGSRC_HOST_WORK_DIR)/
	rm -rf $(PKGSRC_HOST_DIR)/
	rm -rf $(PKGSRC_SOURCE_DIR)/
endef

host-pkgsrc-update-categories: $(PKGSRC_SOURCE_DIR)/../.stamp_host_installed pkgsrc-prepare
	( export PATH="$(HOST_DIR)/usr/bin:$(PKGSRC_HOST_DIR)/bin:$(PATH)"; \
		./package/pkgsrc/update-pkg-list.sh \
			$(PKGSRC_SOURCE_DIR) \
			$(PKGSRC_PACKAGE_DIR) \
	)

host-pkgsrc-update-platform-tools:
	export PATH="$(HOST_DIR)/usr/bin:$(PKGSRC_HOST_DIR)/bin:$(PATH)"; \
	for pkg in $(PKGSRC_PLATFORM_TOOLS); \
	do \
		$(PKGSRC_BMAKE) -C $(PKGSRC_SOURCE_DIR)/$$pkg $(PKGSRC_BMAKE_HOST_OPTS) install ; \
	done

HOST_SOURCE += host-pkgsrc-source

$(eval $(host-generic-package))
